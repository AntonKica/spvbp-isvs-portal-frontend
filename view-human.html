<!DOCTYPE html>
<html lang="sk">
  <head>
    <meta charset="UTF-8">
    <title>Humans </title>

    <script src="https://unpkg.com/htmx.org@1.9.9" integrity="sha384-QFjmbokDn2DjBjq+fM+8LUIVrAgqcNW2s0PjAxHETgRn9l4fvX31ZxDxvwQnyMOX" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
    <script src="common.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
  </head>

  <body onload="loadHuman()">
    <div class="row p-3">
      <div class="col bg-primary rounded">
        <span class="text-white fs-2"> Meno: </span>
      </div>
      <div class="col">
        <span class="text-primary fs-2" id="firstName"></span>
      </div>
    </div>
    <div class="row p-3">
      <div class="col bg-primary rounded">
        <span class="text-white fs-2"> Priezvisko: </span>
      </div>
      <div class="col">
        <span class="text-primary fs-2" id="lastName"></span>
      </div>
    </div>
    <table class="table">
      <thead>
        <tr>
          <!--why scope?-->
          <th scope="col">Priradene role</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody id="roleRows">
      </tbody>
    </table>
    <hr>
      <h2> Prirad novu rolu</h2>
    <form id="bindRole">
      <select class="form-control" name="roleId" id="roleOptions">
      </select>
      <input type="submit" class="btn btn-primary" value="Pridaj rolu" onclick="bindRole(event)">
    </form>

    <script>
      function getHumanId() {
        return (new URL(document.location)).searchParams.get("humanId")

      }

      function setHumanInfo(data) {
        document.getElementById("firstName").innerHTML = data.firstName
        document.getElementById("lastName").innerHTML = data.lastName
      }
      function setRoleInfo(data) {
        const rows = data.roles.map(role => `
          <tr>
          <td>${role.name}</td>
          <td> <button type="button" class="btn btn-danger" onclick="unbindRole(event, ${role.id})">remove</button></td>
          </tr>
          `).join("")
        document.getElementById("roleRows").innerHTML = rows
      }
      function setBindInfo(data) {
        const roleIds = data.roles.map(role => role.id)
        console.log(roleIds)

        fetch('http://spvbp-isvs.local/svc/role/list')
          .then(response => response.json())
          .then(roles => roles.filter(role => !roleIds.includes(role.id)))
          .then(roles => roles.map(role => `<option value="${role.id}">${role.name}</option>`))
          .then(options => document.getElementById("roleOptions").innerHTML = options)
      }
      function loadHuman() {
        const humanId = getHumanId()

        fetch(`http://spvbp-isvs.local/svc/human/${humanId}`)
          .then(response => response.json()) // Parse the JSON response
          .then(data => {
            setHumanInfo(data)
            setRoleInfo(data)
            setBindInfo(data)
          })
          .catch(error => {
            // Handle any errors that occurred during the fetch
            console.error('Error fetching data:', error)
          })
      }

      async function bindRole(event) {
        event.preventDefault()

        const bindRoleForm = document.getElementById('bindRole')
        const formData = new FormData(bindRoleForm)

        const humanId = getHumanId()
        const roleId = formData.get("roleId")

        const res = await fetch(`http://spvbp-isvs.local/svc/human/${humanId}/bind/role/${roleId}`, { method: "POST"})
        const text = await res.text()
        alert(text)
        if(res.ok) {
          window.location.reload()
        }
      }
      async function unbindRole(event, roleId) {
        event.preventDefault()

        const humanId = getHumanId()

        const res = await fetch(`http://spvbp-isvs.local/svc/human/${humanId}/unbind/role/${roleId}`, { method: "POST"})
        const text = await res.text()
        alert(text)
        if(res.ok) {
          window.location.reload()
        }
      }
    </script>
  </body>
</html>
